name: "E2E GitOps Pipeline - SAST, Build, Scan, Deploy"

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'version.txt'
      - 'deployment.yaml'

jobs:
  sonarcloud_sast_scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: SonarCloud Quality Gate Check
        uses: sonarsource/sonarqube-quality-gate-action@master
        continue-on-error: true
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  build_push_docker_image:
    runs-on: ubuntu-latest
    needs: sonarcloud_sast_scan
    outputs:
      version: ${{ steps.set_version.outputs.version }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set Dynamic Version
        id: set_version
        run: |
          if [ -f version.txt ]; then
            VERSION=$(cat version.txt)
          else
            VERSION="1.0"
          fi
          
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          NEW_MINOR=$((MINOR + 1))
          NEW_VERSION="${MAJOR}.${NEW_MINOR}"
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/supermario-game:v${{ steps.set_version.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/supermario-game:latest

  container_security_scan:
    runs-on: ubuntu-latest
    needs: build_push_docker_image
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/supermario-game:v${{ needs.build_push_docker_image.outputs.version }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy Results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run Trivy with Quality Gate
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          image-ref: ${{ secrets.DOCKERHUB_USERNAME }}/supermario-game:v${{ needs.build_push_docker_image.outputs.version }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'

  update_deployment_manifests:
    runs-on: ubuntu-latest
    needs: [build_push_docker_image, container_security_scan]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update Deployment and Version Files
        run: |
          NEW_VERSION="${{ needs.build_push_docker_image.outputs.version }}"
          
          # Update deployment.yaml
          sed -i "s|image: ${{ secrets.DOCKERHUB_USERNAME }}/supermario-game:.*|image: ${{ secrets.DOCKERHUB_USERNAME }}/supermario-game:v${NEW_VERSION}|g" deployment.yaml
          
          # Update version.txt
          echo "${NEW_VERSION}" > version.txt
          
          # Commit and push
          git add deployment.yaml version.txt
          git commit -m "chore: bump version to v${NEW_VERSION} [skip ci]"
          git push
